<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partyservice Kleinfeldt - Auftragserfassung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            flex: 1;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .row {
            display: flex;
            gap: 20px;
        }
        
        .col {
            flex: 1;
        }
        
        .time-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .time-picker select {
            width: 80px;
        }
        
        .auftraege-liste {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .auftrag {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            break-inside: avoid;
        }
        
        .auftrag:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .auftraege-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .auftraege-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .speise-block {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            border: 2px solid #e1e8ed;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .speise-block:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .speise-block button {
            width: auto;
            padding: 5px 15px;
            margin-top: 10px;
            background: #dc3545;
        }
        
        .beilagen-container {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .data-management {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .data-management h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .data-management button {
            width: auto;
            padding: 8px 15px;
            margin-right: 10px;
        }
        
        .data-management .export-btn {
            background: #28a745;
        }
        
        .data-management .import-btn {
            background: #007bff;
        }
        
        .data-management .delete-btn {
            background: #dc3545;
        }
        
        .data-management p {
            margin: 10px 0 0 0;
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è Partyservice Kleinfeldt ‚Äì Auftragserfassung</h1>
            <p>Kr√§henstra√üe 29, 23552 L√ºbeck | üìû 0451-75230</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3 id="total">Gesamt: 0</h3>
            </div>
            <div class="stat-card">
                <h3 id="week">Diese Woche: 0</h3>
            </div>
            <div class="stat-card">
                <h3 id="today">Heute: 0</h3>
            </div>
        </div>
        
        <div class="form-section">
            <h2>üìù Neuer Auftrag</h2>
            
            <div class="form-group">
                <label for="kunde">Kundenname:</label>
                <input type="text" id="kunde" placeholder="Name des Kunden">
            </div>
            
            <div class="form-group">
                <label for="telefon">Telefonnummer:</label>
                <input type="tel" id="telefon" placeholder="Telefonnummer des Kunden">
            </div>
            
            <div class="form-group">
                <label for="notizen">Notizen:</label>
                <textarea id="notizen" placeholder="Individuelle Notizen zum Auftrag" rows="3" style="resize: vertical; font-family: Arial, sans-serif;"></textarea>
            </div>
            
            <div class="row">
                <div class="col">
                    <label for="datum">Datum:</label>
                    <input type="date" id="datum">
                </div>
                <div class="col">
                    <label>Uhrzeit:</label>
                    <div class="time-picker">
                        <select id="stunden">
                            <option value="">Std</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                        </select>
                        <span>:</span>
                        <select id="minuten">
                            <option value="">Min</option>
                            <option value="00">00</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="ort">Lieferort:</label>
                <input type="text" id="ort" placeholder="Adresse f√ºr die Lieferung">
            </div>
            
            <div class="form-group">
                <label for="gaeste">Anzahl G√§ste:</label>
                <input type="number" id="gaeste" min="1" placeholder="Anzahl der G√§ste">
            </div>
            
            <h3>üç≤ Vorspeisen</h3>
            <div id="vorspeisen-container"></div>
            <button type="button" onclick="addVorspeise()">+ Vorspeise hinzuf√ºgen</button>
            
            <h3>üçñ Hauptspeisen & Beilagen</h3>
            <div id="hauptspeisen-container"></div>
            <button type="button" onclick="addHauptspeise()">+ Hauptspeise hinzuf√ºgen</button>
            
            <h3>üç∞ Nachspeisen</h3>
            <div id="nachspeisen-container"></div>
            <button type="button" onclick="addNachspeise()">+ Nachspeise hinzuf√ºgen</button>
            
            <button onclick="speichereAuftrag()">‚úÖ Auftrag speichern</button>
        </div>
        
        <div class="auftraege-liste">
            <h2>üìã Auftr√§ge</h2>
            
            <div class="row">
                <div class="col">
                    <label for="filterTyp">Filter-Art:</label>
                    <select id="filterTyp" onchange="updateFilterOptions()">
                        <option value="alle">Alle Auftr√§ge anzeigen</option>
                        <option value="datum">Nach Datum filtern</option>
                        <option value="woche">Nach Kalenderwoche filtern</option>
                    </select>
                </div>
                <div class="col">
                    <label for="filterWert">Filter:</label>
                    <input type="date" id="filterWert" onchange="zeigeAuftraege()" style="display: none;">
                    <select id="filterWoche" onchange="zeigeAuftraege()" style="display: none;">
                        <option value="">-- Kalenderwoche w√§hlen --</option>
                    </select>
                </div>
            </div>
            
            <button onclick="druckeAuswahl()" style="margin-bottom: 20px;">üñ®Ô∏è Auswahl drucken</button>
            
            <div class="data-management">
                <h4>üíæ Datenverwaltung:</h4>
                <button onclick="exportiereBackup()" class="export-btn">
                    üì§ Backup exportieren
                </button>
                <button onclick="importiereBackup()" class="import-btn">
                    üì• Backup importieren
                </button>
                <button onclick="loescheAlleDaten()" class="delete-btn">
                    üóëÔ∏è Alle Daten l√∂schen
                </button>
                <p>üí° Tipp: Exportieren Sie regelm√§√üig Backups Ihrer Auftr√§ge!</p>
            </div>
            
            <div id="liste">
                <p style="color: #666;">Noch keine Auftr√§ge vorhanden.</p>
            </div>
        </div>
    </div>

    <script>
        let auftraege = [];
        
        // Vorspeisen hinzuf√ºgen
        function addVorspeise() {
            const container = document.getElementById('vorspeisen-container');
            const block = document.createElement('div');
            block.className = 'speise-block';
            block.innerHTML = `
                <label>Vorspeise:</label>
                <select>
                    <option>-- Bitte w√§hlen --</option>
                    <option>Kartoffelsuppe mit W√ºrstchen</option>
                    <option>Kartoffelsuppe Vegetarisch</option>
                    <option>Lauch Hack Suppe</option>
                    <option>Gulaschsuppe</option>
                    <option>Broccolicremesuppe</option>
                    <option>Chilli Con Carne</option>
                    <option>Chilli Sin Carne</option>
                </select>
                <label>Personenzahl:</label>
                <input type="number" min="1" placeholder="Anzahl Personen">
                <label><input type="checkbox"> Brot dazu?</label>
                <button type="button" onclick="this.parentElement.remove()">üóëÔ∏è Entfernen</button>
            `;
            container.appendChild(block);
        }
        
        // Backshop-Notizen ein-/ausblenden
        function toggleBackshopNotizen(nachspeiseId, selectedValue) {
            const speisenDiv = document.getElementById(nachspeiseId + '_speisen');
            const notizenDiv = speisenDiv.querySelector('.backshop-notizen');
            
            // Notizfeld nur f√ºr Bagel und Canap√©s anzeigen
            if (selectedValue === 'Bagel - belegt' || selectedValue === 'Canap√©s') {
                notizenDiv.style.display = 'block';
            } else {
                notizenDiv.style.display = 'none';
            }
        }
        
        // Individuelle Eingabe f√ºr Hauptspeisen togglen
        function toggleIndividuelleEingabe(selectElement) {
            const block = selectElement.closest('.speise-block');
            const individuellDiv = block.querySelector('.individuelle-eingabe');
            
            if (selectElement.value === 'individuell') {
                individuellDiv.style.display = 'block';
            } else {
                individuellDiv.style.display = 'none';
            }
        }
        
        // Hauptspeisen hinzuf√ºgen
        function addHauptspeise() {
            const container = document.getElementById('hauptspeisen-container');
            const block = document.createElement('div');
            block.className = 'speise-block';
            const beilagenId = 'beilagen_' + Date.now();
            block.innerHTML = `
                <label>Hauptspeise:</label>
                <select onchange="toggleIndividuelleEingabe(this)">
                    <option>-- Bitte w√§hlen --</option>
                    <option>Spanferkel mit Beilagen</option>
                    <option>BBQ Schwein mit Beilagen</option>
                    <option>Spanferkel ohne Beilagen</option>
                    <option>BBQ Schwein ohne Beilagen</option>
                    <option>Honigschinken</option>
                    <option>Grillschinken</option>
                    <option>Glasierte Pute</option>
                    <option>Rinderbraten</option>
                    <option>Rinderrouladen</option>
                    <option>Kr√§uterbraten</option>
                    <option>Gyrosbraten</option>
                    <option>Griechischer Rahmbraten</option>
                    <option>Spie√übraten</option>
                    <option>Altdeutscher Bierbraten</option>
                    <option>Schweinefilet in Sahnesauce</option>
                    <option>Kassler im Bl√§tterteig</option>
                    <option>Bayrischer Leberk√§se</option>
                    <option>Gr√ºnkohl</option>
                    <option>Wildschweinbraten</option>
                    <option>Vegetarische Gem√ºseschnitzel</option>
                    <option>Amerikanische Knabbereien</option>
                    <option>Pulled Pork</option>
                    <option value="individuell">üéØ Individuelle Speise (Sonderwunsch)</option>
                </select>
                <div class="individuelle-eingabe" style="display: none; margin-top: 10px;">
                    <label>Individuelle Speise:</label>
                    <input type="text" placeholder="Beschreibung der individuellen Speise" class="individuelle-speise">
                </div>
                <label>Personenzahl:</label>
                <input type="number" min="1" placeholder="Anzahl Personen">
                <div class="beilagen-container" id="${beilagenId}"></div>
                <button type="button" onclick="addBeilage('${beilagenId}')">+ Beilage hinzuf√ºgen</button>
                <button type="button" onclick="this.parentElement.remove()">üóëÔ∏è Hauptspeise entfernen</button>
            `;
            container.appendChild(block);
        }
        
        // Beilagen hinzuf√ºgen
        function addBeilage(containerId) {
            const container = document.getElementById(containerId);
            const block = document.createElement('div');
            block.className = 'speise-block';
            block.style.marginLeft = '0';
            block.innerHTML = `
                <label>Beilage:</label>
                <select>
                    <option disabled>-- Kartoffelbeilagen --</option>
                    <option>Kartoffelgratin</option>
                    <option>R√∂stkartoffeln</option>
                    <option>Kartoffelspalten</option>
                    <option>Salzkartoffeln</option>
                    <option>Bratkartoffeln</option>
                    <option>Kartoffelkl√∂√üe</option>
                    <option>Reis</option>
                    <option disabled>-- Gem√ºse --</option>
                    <option>bunte Gem√ºseauswahl</option>
                    <option>geschmortes Kraut</option>
                    <option>Rotkohl</option>
                    <option>Erbsen & M√∂hren</option>
                    <option>Rosenkohl</option>
                    <option>Blumenkohl</option>
                    <option disabled>-- Salate --</option>
                    <option>Kartoffelsalat</option>
                    <option>Speckkartoffelsalat</option>
                    <option>Nudelsalat</option>
                    <option>frischer gemischter Salat</option>
                    <option>Eisberg Melonen Salat</option>
                    <option>Griechischer Salat</option>
                    <option>Krautsalat Natur</option>
                    <option>Krautsalat in Yogurtso√üe</option>
                </select>
                <label>Personenzahl:</label>
                <input type="number" min="1" placeholder="Anzahl Personen">
                <button type="button" onclick="this.parentElement.remove()">üóëÔ∏è Beilage entfernen</button>
            `;
            container.appendChild(block);
        }
        
        // Nachspeisen hinzuf√ºgen
        function addNachspeise() {
            const container = document.getElementById('nachspeisen-container');
            const block = document.createElement('div');
            block.className = 'speise-block';
            const nachspeiseId = 'nachspeise_' + Date.now();
            block.innerHTML = `
                <label>Nachspeisen-Kategorie:</label>
                <select onchange="updateNachspeisenOptionen('${nachspeiseId}')">
                    <option value="">-- Kategorie w√§hlen --</option>
                    <option value="N1">N1 - Gro√üe Schale (Standard-Portionen)</option>
                    <option value="N2">N2 - Kleine Portionssch√§lchen</option>
                    <option value="N3">N3 - Gourmet Nachspeisen</option>
                    <option value="Backshop">üßÅ Backshop - Kuchen, Donuts & Muffins</option>
                </select>
                <div id="${nachspeiseId}_speisen" style="margin-top: 10px; display: none;">
                    <label>Nachspeise:</label>
                    <select class="nachspeise-auswahl">
                        <option>-- Erst Kategorie w√§hlen --</option>
                    </select>
                    <label class="mengen-label">Personenzahl:</label>
                    <input type="number" min="1" placeholder="Anzahl Personen">
                    <div class="backshop-notizen" style="display: none; margin-top: 10px;">
                        <label>Belag-Details:</label>
                        <textarea placeholder="z.B. 5x Lachs, 4x Schinken, 3x vegetarisch" rows="2" style="resize: vertical; font-family: Arial, sans-serif;"></textarea>
                    </div>
                </div>
                <button type="button" onclick="this.parentElement.remove()">üóëÔ∏è Entfernen</button>
            `;
            container.appendChild(block);
        }

        // Nachspeisen-Optionen aktualisieren
        function updateNachspeisenOptionen(nachspeiseId) {
            const kategorie = event.target.value;
            const speisenDiv = document.getElementById(nachspeiseId + '_speisen');
            const speisenSelect = speisenDiv.querySelector('.nachspeise-auswahl');
            const mengenLabel = speisenDiv.querySelector('.mengen-label');
            const mengenInput = speisenDiv.querySelector('input[type="number"]');
            
            if (!kategorie) {
                speisenDiv.style.display = 'none';
                return;
            }
            
            speisenDiv.style.display = 'block';
            speisenSelect.innerHTML = '<option>-- Bitte w√§hlen --</option>';
            
            // Labels und Placeholder je nach Kategorie anpassen
            if (kategorie === 'Backshop') {
                mengenLabel.textContent = 'Menge:';
                mengenInput.placeholder = 'Anzahl (Bleche/St√ºck)';
            } else {
                mengenLabel.textContent = 'Personenzahl:';
                mengenInput.placeholder = 'Anzahl Personen';
            }
            
            // Optionen je nach Kategorie
            let optionen = [];
            
            if (kategorie === 'N1' || kategorie === 'N2') {
                optionen = [
                    'Mousse au Chocolat',
                    'Rote Gr√ºtze mit Vanilleso√üe',
                    'Tiramisu',
                    'Obstsalat',
                    'Mascarponequark mit Himbeermark',
                    'Vanillemousse'
                ];
            } else if (kategorie === 'N3') {
                optionen = [
                    'Bayrische Creme mit Tellerbiskuit und Erdbeere',
                    'Karamell mit Schokoso√üe',
                    'Frischk√§secreme mit Aprikose',
                    'Schwarzw√§lder Kirsch',
                    'Joghurtcreme mit zweierlei von der Himbeere'
                ];
            } else if (kategorie === 'Backshop') {
                speisenSelect.innerHTML = `
                    <option value="">-- Backware w√§hlen --</option>
                    <optgroup label="üç∞ Blechkuchen (15 St√ºcke/Blech)">
                        <option value="Blechkuchen - Zitronenkuchen">Zitronenkuchen</option>
                        <option value="Blechkuchen - Quark-Mandarine">Quark-Mandarine</option>
                        <option value="Blechkuchen - Quark-Kirsche">Quark-Kirsche</option>
                        <option value="Blechkuchen - Apfelkuchen mit Zimt">Apfelkuchen mit Zimt</option>
                        <option value="Blechkuchen - Butterkuchen mit Mandeln">Butterkuchen mit Mandeln</option>
                        <option value="Blechkuchen - Schokokuchen">Schokokuchen</option>
                    </optgroup>
                    <optgroup label="ü•ñ Belegte Br√∂tchen (halbe Br√∂tchen)">
                        <option value="Br√∂tchen - hell Normalbelag">Halbes Br√∂tchen hell (Normalbelag)</option>
                        <option value="Br√∂tchen - dunkel Normalbelag">Halbes Br√∂tchen dunkel (Normalbelag)</option>
                        <option value="Br√∂tchen - hell Premiumbelag">Halbes Br√∂tchen hell (Premiumbelag)</option>
                        <option value="Br√∂tchen - dunkel Premiumbelag">Halbes Br√∂tchen dunkel (Premiumbelag)</option>
                    </optgroup>
                    <optgroup label="üç© Donuts (einzeln)">
                        <option value="Donut - K√§sekuchen">K√§sekuchen</option>
                        <option value="Donut - Vanille">Vanille</option>
                        <option value="Donut - Schoko">Schoko</option>
                        <option value="Donut - Kaugummi">Kaugummi</option>
                        <option value="Donut - Pinky Crunch">Pinky Crunch</option>
                    </optgroup>
                    <optgroup label="üßÅ Muffins (einzeln)">
                        <option value="Muffin - Blaubeere">Blaubeere</option>
                        <option value="Muffin - Apfel">Apfel</option>
                        <option value="Muffin - Marmor">Marmor</option>
                        <option value="Muffin - Schoko">Schoko</option>
                    </optgroup>
                    <optgroup label="ü•Ø Spezialit√§ten (mit Notizen)">
                        <option value="Bagel - belegt">Halber belegter Bagel</option>
                        <option value="Canap√©s">Canap√©s</option>
                    </optgroup>
                `;
                
                // Event-Listener f√ºr Backshop-Notizen hinzuf√ºgen
                setTimeout(() => {
                    const backshopSelect = speisenDiv.querySelector('.nachspeise-auswahl');
                    if (backshopSelect) {
                        backshopSelect.addEventListener('change', function() {
                            toggleBackshopNotizen(nachspeiseId, this.value);
                        });
                    }
                }, 10);
                
                return;
            }
            
            optionen.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                speisenSelect.appendChild(optionElement);
            });
        }
        
        // Berechnungsfunktionen
        function berechneVorspeise(speise, anzahl, mitBrot) {
            const liter = anzahl * 0.5; // 0,5 Liter pro Person f√ºr alle Suppen
            let ergebnis = { 
                menge: liter, 
                einheit: liter >= 1 ? 'L' : 'ml',
                anzeige: liter >= 1 ? `${liter.toFixed(1)} L` : `${(liter * 1000)} ml`,
                zusatz: '' 
            };
            
            if (mitBrot) {
                const brote = Math.ceil(anzahl / 6);
                ergebnis.zusatz = ` + ${brote} Brot${brote > 1 ? 'e' : ''}`;
            }
            
            return ergebnis;
        }

        function berechneHauptspeise(speise, anzahl) {
            let ergebnis = { gewicht: 0, einheit: 'g', zusatz: '' };
            
            switch(speise) {
                case 'Spanferkel mit Beilagen':
                case 'Spanferkel ohne Beilagen':
                case 'BBQ Schwein mit Beilagen':
                case 'BBQ Schwein ohne Beilagen':
                    ergebnis.gewicht = anzahl * 650; // 650g f√ºr Spanferkel/BBQ
                    if (speise.includes('mit Beilagen')) {
                        const brote = Math.ceil(anzahl / 10);
                        ergebnis.zusatz = ` + ${brote} Brot${brote > 1 ? 'e' : ''}`;
                    }
                    break;
                    
                case 'Pulled Pork':
                    ergebnis.gewicht = anzahl * 300; // 300g f√ºr Pulled Pork
                    const brotePulled = Math.ceil(anzahl / 10);
                    ergebnis.zusatz = ` + ${brotePulled} Brot${brotePulled > 1 ? 'e' : ''}`;
                    break;
                    
                case 'Rinderrouladen':
                    ergebnis.gewicht = anzahl * 300; // 300g f√ºr Rinderrouladen
                    break;
                    
                case 'Vegetarische Gem√ºseschnitzel':
                    ergebnis.gewicht = 0; // Kein Gewicht, da St√ºckzahl
                    ergebnis.einheit = 'St√ºck';
                    ergebnis.zusatz = `${anzahl * 2} Schnitzel`; // 2 Schnitzel pro Person
                    return ergebnis;
                    
                case 'Amerikanische Knabbereien':
                    // Spezielle Berechnung f√ºr Amerikanische Knabbereien
                    const rippen = Math.ceil((anzahl / 5) * 3); // 3 Rippen pro 5 Personen
                    const wings = anzahl * 4; // 4 Wings pro Person
                    const finger = anzahl * 4; // 4 Chicken Finger pro Person
                    const broteAmerikan = Math.ceil(anzahl / 10);
                    
                    ergebnis.gewicht = 0; // Kein Gewicht, da aufgeschl√ºsselt
                    ergebnis.einheit = '';
                    ergebnis.zusatz = `${rippen} Rippen, ${wings} Wings, ${finger} Chicken Finger + ${broteAmerikan} Brot${broteAmerikan > 1 ? 'e' : ''}`;
                    return ergebnis;
                    
                default:
                    // F√ºr individuelle Speisen oder unbekannte Speisen
                    if (speise.includes('individuell:') || speise === 'individuell') {
                        ergebnis.gewicht = 0;
                        ergebnis.einheit = '';
                        ergebnis.zusatz = '(individuelle Speise - keine Berechnung)';
                        return ergebnis;
                    }
                    ergebnis.gewicht = anzahl * 250; // Standard 250g pro Person
            }
            
            return ergebnis;
        }
        
        // Speisen sammeln
        function sammeleSpeisen() {
            const vorspeisen = [];
            const hauptspeisen = [];
            const beilagen = [];
            const nachspeisen = [];
            
            // Vorspeisen sammeln
            document.querySelectorAll('#vorspeisen-container .speise-block').forEach((block) => {
                const select = block.querySelector('select');
                const anzahl = block.querySelector('input[type="number"]');
                const brot = block.querySelector('input[type="checkbox"]');
                
                if (select && anzahl && select.value !== '-- Bitte w√§hlen --' && parseInt(anzahl.value) > 0) {
                    vorspeisen.push({
                        speise: select.value,
                        anzahl: parseInt(anzahl.value),
                        brot: brot ? brot.checked : false
                    });
                }
            });
            
            // Hauptspeisen sammeln (mit zugeh√∂rigen Beilagen)
            document.querySelectorAll('#hauptspeisen-container .speise-block').forEach((block) => {
                const select = block.querySelector('select');
                const anzahl = block.querySelector('input[type="number"]');
                const individuellInput = block.querySelector('.individuelle-speise');
                
                if (select && anzahl && parseInt(anzahl.value) > 0) {
                    let speiseName = select.value;
                    
                    // Pr√ºfen ob individuelle Speise gew√§hlt wurde
                    if (select.value === 'individuell' && individuellInput && individuellInput.value.trim()) {
                        speiseName = `individuell: ${individuellInput.value.trim()}`;
                    } else if (select.value === 'individuell') {
                        return; // √úberspringen wenn individuell gew√§hlt aber nichts eingegeben
                    } else if (select.value === '-- Bitte w√§hlen --') {
                        return; // √úberspringen wenn nichts gew√§hlt
                    }
                    
                    // Beilagen zu dieser Hauptspeise sammeln
                    const hauptspeiseBeilagen = [];
                    block.querySelectorAll('.beilagen-container .speise-block').forEach((beilageBlock) => {
                        const beilageSelect = beilageBlock.querySelector('select');
                        const beilageAnzahl = beilageBlock.querySelector('input[type="number"]');
                        
                        if (beilageSelect && beilageAnzahl && beilageSelect.value && parseInt(beilageAnzahl.value) > 0) {
                            hauptspeiseBeilagen.push({
                                speise: beilageSelect.value,
                                anzahl: parseInt(beilageAnzahl.value)
                            });
                            
                            // Auch zur globalen Beilagen-Liste f√ºr Zusammenfassung hinzuf√ºgen
                            beilagen.push({
                                speise: beilageSelect.value,
                                anzahl: parseInt(beilageAnzahl.value)
                            });
                        }
                    });
                    
                    hauptspeisen.push({
                        speise: speiseName,
                        anzahl: parseInt(anzahl.value),
                        beilagen: hauptspeiseBeilagen // Beilagen zu dieser Hauptspeise
                    });
                }
            });
            
            // Nachspeisen sammeln
            document.querySelectorAll('#nachspeisen-container .speise-block').forEach((block) => {
                const kategorieSelect = block.querySelector('select');
                const speisenDiv = block.querySelector('[id$="_speisen"]');
                
                if (kategorieSelect && speisenDiv && kategorieSelect.value) {
                    const speisenSelect = speisenDiv.querySelector('.nachspeise-auswahl');
                    const anzahlInput = speisenDiv.querySelector('input[type="number"]');
                    const notizenTextarea = speisenDiv.querySelector('.backshop-notizen textarea');
                    
                    if (speisenSelect && anzahlInput && speisenSelect.value !== '-- Bitte w√§hlen --' && parseInt(anzahlInput.value) > 0) {
                        const nachspeise = {
                            kategorie: kategorieSelect.value,
                            speise: speisenSelect.value,
                            anzahl: parseInt(anzahlInput.value)
                        };
                        
                        // Backshop-Notizen hinzuf√ºgen, falls vorhanden
                        if (notizenTextarea && notizenTextarea.value.trim()) {
                            nachspeise.backshopNotizen = notizenTextarea.value.trim();
                        }
                        
                        nachspeisen.push(nachspeise);
                    }
                }
            });
            
            return { vorspeisen, hauptspeisen, beilagen, nachspeisen };
        }
        
        // Beilagen zusammenfassen
        function fasseBeilagenZusammen(beilagen) {
            const zusammengefasst = {};
            
            beilagen.forEach(beilage => {
                if (zusammengefasst[beilage.speise]) {
                    zusammengefasst[beilage.speise] += beilage.anzahl;
                } else {
                    zusammengefasst[beilage.speise] = beilage.anzahl;
                }
            });
            
            return Object.entries(zusammengefasst).map(([speise, anzahl]) => ({
                speise: speise,
                anzahl: anzahl
            }));
        }
        
        // Auftrag speichern
        function speichereAuftrag() {
            const kunde = document.getElementById('kunde').value;
            const telefon = document.getElementById('telefon').value;
            const notizen = document.getElementById('notizen').value;
            const datum = document.getElementById('datum').value;
            const stunden = document.getElementById('stunden').value;
            const minuten = document.getElementById('minuten').value;
            const ort = document.getElementById('ort').value;
            const gaeste = document.getElementById('gaeste').value;
            
            if (!kunde || !datum || !stunden || !minuten || !ort || !gaeste) {
                alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                return;
            }
            
            const speisen = sammeleSpeisen();
            const beilagenZusammengefasst = fasseBeilagenZusammen(speisen.beilagen);
            
            const auftrag = {
                id: Date.now(),
                kunde: kunde,
                telefon: telefon,
                notizen: notizen,
                datum: datum,
                zeit: stunden + ':' + minuten,
                ort: ort,
                gaeste: parseInt(gaeste),
                vorspeisen: speisen.vorspeisen,
                hauptspeisen: speisen.hauptspeisen,
                beilagen: beilagenZusammengefasst,
                nachspeisen: speisen.nachspeisen
            };
            
            auftraege.push(auftrag);
            zeigeAuftraege();
            updateStats();
            
            // Formular leeren
            document.getElementById('kunde').value = '';
            document.getElementById('telefon').value = '';
            document.getElementById('notizen').value = '';
            document.getElementById('datum').value = '';
            document.getElementById('stunden').value = '';
            document.getElementById('minuten').value = '';
            document.getElementById('ort').value = '';
            document.getElementById('gaeste').value = '';
            document.getElementById('vorspeisen-container').innerHTML = '';
            document.getElementById('hauptspeisen-container').innerHTML = '';
            document.getElementById('nachspeisen-container').innerHTML = '';
        }
        
        // Auftr√§ge anzeigen
        function zeigeAuftraege() {
            const liste = document.getElementById('liste');
            
            // Filter anwenden
            const filterTyp = document.getElementById("filterTyp").value;
            let gefiltert = auftraege;
            
            if (filterTyp === 'datum') {
                const filterDatum = document.getElementById("filterWert").value;
                if (filterDatum) {
                    gefiltert = auftraege.filter(a => a.datum === filterDatum);
                }
            } else if (filterTyp === 'woche') {
                const filterWoche = document.getElementById("filterWoche").value;
                if (filterWoche) {
                    const [jahr, woche] = filterWoche.split('-').map(Number);
                    const { start, end } = getDateFromWeek(jahr, woche);
                    
                    gefiltert = auftraege.filter(a => {
                        const auftragsDatum = new Date(a.datum);
                        return auftragsDatum >= start && auftragsDatum <= end;
                    });
                }
            }
            
            // Nach Datum sortieren
            gefiltert.sort((a, b) => new Date(a.datum + 'T' + a.zeit) - new Date(b.datum + 'T' + b.zeit));
            
            if (gefiltert.length === 0) {
                liste.innerHTML = '<p style="color: #666;">Keine Auftr√§ge f√ºr den gew√§hlten Filter gefunden.</p>';
                return;
            }
            
            let html = '<div class="auftraege-grid">';
            gefiltert.forEach(auftrag => {
                const kw = getWeekNumber(auftrag.datum);
                let speisenHtml = '';
                
                // Vorspeisen anzeigen
                if (auftrag.vorspeisen && auftrag.vorspeisen.length > 0) {
                    speisenHtml += '<br><strong>Vorspeisen:</strong><br>';
                    auftrag.vorspeisen.forEach(v => {
                        const liter = v.anzahl * 0.5;
                        const literText = liter >= 1 ? `${liter.toFixed(1)} L` : `${(liter * 1000)} ml`;
                        const brotText = v.brot ? ` + ${Math.ceil(v.anzahl / 6)} Brot${Math.ceil(v.anzahl / 6) > 1 ? 'e' : ''}` : '';
                        speisenHtml += `‚Ä¢ ${v.speise} (${v.anzahl} Pers., ${literText})${brotText}<br>`;
                    });
                }
                
                // Hauptspeisen anzeigen
                if (auftrag.hauptspeisen && auftrag.hauptspeisen.length > 0) {
                    speisenHtml += '<br><strong>Hauptspeisen:</strong><br>';
                    auftrag.hauptspeisen.forEach(h => {
                        const berechnung = berechneHauptspeise(h.speise, h.anzahl);
                        
                        if (berechnung.gewicht > 0) {
                            const gewichtText = berechnung.gewicht >= 1000 ? `${(berechnung.gewicht/1000).toFixed(1)} kg` : `${berechnung.gewicht} g`;
                            speisenHtml += `‚Ä¢ ${h.speise} (${h.anzahl} Pers., ${gewichtText})${berechnung.zusatz}<br>`;
                        } else if (berechnung.zusatz.includes('Schnitzel')) {
                            // Spezielle Anzeige f√ºr Gem√ºseschnitzel
                            speisenHtml += `‚Ä¢ ${h.speise} (${h.anzahl} Pers., ${berechnung.zusatz})<br>`;
                        } else {
                            // F√ºr Amerikanische Knabbereien oder individuelle Speisen
                            const speisenName = h.speise.startsWith('individuell:') ? h.speise.replace('individuell: ', '') : h.speise;
                            speisenHtml += `‚Ä¢ ${speisenName} (${h.anzahl} Pers.)${berechnung.zusatz}<br>`;
                        }
                    });
                }
                
                // Beilagen anzeigen
                if (auftrag.beilagen && auftrag.beilagen.length > 0) {
                    speisenHtml += '<br><strong>Beilagen:</strong><br>';
                    auftrag.beilagen.forEach(b => {
                        // Spezielle Behandlung f√ºr bestimmte Salate (nur Personenanzahl)
                        const nurPersonenSalate = ['frischer gemischter Salat', 'Griechischer Salat', 'Eisberg Melonen Salat'];
                        
                        if (nurPersonenSalate.includes(b.speise)) {
                            speisenHtml += `‚Ä¢ ${b.speise} (${b.anzahl} Pers.)<br>`;
                        } else {
                            // Standard-Berechnung mit Gewicht (250g pro Person)
                            const gewicht = b.anzahl * 250;
                            const gewichtText = gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`;
                            speisenHtml += `‚Ä¢ ${b.speise} (${b.anzahl} Pers., ${gewichtText})<br>`;
                        }
                    });
                }
                
                // Nachspeisen anzeigen
                if (auftrag.nachspeisen && auftrag.nachspeisen.length > 0) {
                    speisenHtml += '<br><strong>Nachspeisen:</strong><br>';
                    auftrag.nachspeisen.forEach(n => {
                        let kategorieText = '';
                        let mengenText = '';
                        
                        if (n.kategorie === 'N1') {
                            kategorieText = '[N1 - Gro√üe Schale] ';
                            const gewicht = n.anzahl * 120;
                            mengenText = `(${n.anzahl} Pers., ${gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`})`;
                        } else if (n.kategorie === 'N2') {
                            kategorieText = '[N2 - Kleine Sch√§lchen] ';
                            const gewicht = n.anzahl * 120;
                            mengenText = `(${n.anzahl} Pers., ${gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`})`;
                        } else if (n.kategorie === 'N3') {
                            kategorieText = '[N3 - Gourmet] ';
                            const gewicht = n.anzahl * 120;
                            mengenText = `(${n.anzahl} Pers., ${gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`})`;
                        } else if (n.kategorie === 'Backshop') {
                            kategorieText = '[üßÅ Backshop] ';
                            if (n.speise && n.speise.startsWith('Blechkuchen')) {
                                const stuecke = n.anzahl * 15;
                                mengenText = `(${n.anzahl} Blech${n.anzahl > 1 ? 'e' : ''} = ${stuecke} St√ºcke)`;
                            } else {
                                mengenText = `(${n.anzahl} St√ºck)`;
                            }
                        } else {
                            const gewicht = n.anzahl * 120;
                            mengenText = `(${n.anzahl} Pers., ${gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`})`;
                        }
                        
                        speisenHtml += `‚Ä¢ ${kategorieText}${n.speise} ${mengenText}<br>`;
                        
                        // Backshop-Notizen anzeigen, falls vorhanden
                        if (n.backshopNotizen) {
                            speisenHtml += `&nbsp;&nbsp;üìù ${n.backshopNotizen}<br>`;
                        }
                    });
                }
                
                html += `
                    <div class="auftrag">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <input type="checkbox" class="druckauswahl" data-id="${auftrag.id}" style="width: auto; margin-right: 10px;">
                            <strong style="font-size: 1.1em; color: #667eea;">${auftrag.kunde}</strong>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <span><strong>üìÖ ${auftrag.datum}</strong></span>
                                <span><strong>üïê ${auftrag.zeit}</strong></span>
                                <small style="color: #6c757d;">(KW ${kw})</small>
                            </div>
                            ${auftrag.telefon ? `<div style="margin-bottom: 5px;">üìû ${auftrag.telefon}</div>` : ''}
                            <div style="margin-bottom: 5px;">üìç ${auftrag.ort}</div>
                            <div><strong>üë• ${auftrag.gaeste} G√§ste</strong></div>
                            ${auftrag.notizen ? `<div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 4px; font-style: italic;">üìù ${auftrag.notizen}</div>` : ''}
                        </div>
                        
                        <div style="font-size: 0.95em; line-height: 1.4;">
                            ${speisenHtml}
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="starteBearbeitung(${auftrag.id})" style="width: auto; padding: 8px 12px; background: #007bff; font-size: 0.9em;">
                                ‚úèÔ∏è Bearbeiten
                            </button>
                            <button onclick="loescheAuftrag(${auftrag.id})" style="width: auto; padding: 8px 12px; background: #dc3545; font-size: 0.9em;">
                                üóëÔ∏è L√∂schen
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>'; // Schlie√üe das Grid
            liste.innerHTML = html;
        }
        
        // Auftrag l√∂schen
        function loescheAuftrag(id) {
            if (confirm('Auftrag wirklich l√∂schen?')) {
                auftraege = auftraege.filter(a => a.id !== id);
                zeigeAuftraege();
                updateStats();
            }
        }
        
        // Bearbeitung starten
        function starteBearbeitung(id) {
            const auftrag = auftraege.find(a => a.id === id);
            if (!auftrag) return;
            
            // Formular mit vorhandenen Daten f√ºllen
            document.getElementById('kunde').value = auftrag.kunde;
            document.getElementById('telefon').value = auftrag.telefon || '';
            document.getElementById('notizen').value = auftrag.notizen || '';
            document.getElementById('datum').value = auftrag.datum;
            
            const [stunden, minuten] = auftrag.zeit.split(':');
            document.getElementById('stunden').value = stunden;
            document.getElementById('minuten').value = minuten;
            
            document.getElementById('ort').value = auftrag.ort;
            document.getElementById('gaeste').value = auftrag.gaeste;
            
            // Speisen-Container leeren
            document.getElementById('vorspeisen-container').innerHTML = '';
            document.getElementById('hauptspeisen-container').innerHTML = '';
            document.getElementById('nachspeisen-container').innerHTML = '';
            
            // Vorspeisen wiederherstellen
            if (auftrag.vorspeisen) {
                auftrag.vorspeisen.forEach(vorspeise => {
                    addVorspeise();
                    const letzterBlock = document.querySelector('#vorspeisen-container .speise-block:last-child');
                    letzterBlock.querySelector('select').value = vorspeise.speise;
                    letzterBlock.querySelector('input[type="number"]').value = vorspeise.anzahl;
                    if (vorspeise.brot) {
                        letzterBlock.querySelector('input[type="checkbox"]').checked = true;
                    }
                });
            }
            
            // Hauptspeisen wiederherstellen
            if (auftrag.hauptspeisen) {
                auftrag.hauptspeisen.forEach(hauptspeise => {
                    addHauptspeise();
                    const letzterBlock = document.querySelector('#hauptspeisen-container .speise-block:last-child');
                    const select = letzterBlock.querySelector('select');
                    const anzahlInput = letzterBlock.querySelector('input[type="number"]');
                    const individuellInput = letzterBlock.querySelector('.individuelle-speise');
                    
                    // Pr√ºfen ob es eine individuelle Speise ist
                    if (hauptspeise.speise.startsWith('individuell:')) {
                        select.value = 'individuell';
                        toggleIndividuelleEingabe(select);
                        const individuellText = hauptspeise.speise.replace('individuell: ', '');
                        if (individuellInput) {
                            individuellInput.value = individuellText;
                        }
                    } else {
                        select.value = hauptspeise.speise;
                    }
                    
                    anzahlInput.value = hauptspeise.anzahl;
                });
            }
            
            // Beilagen wiederherstellen (zu den entsprechenden Hauptspeisen)
            if (auftrag.beilagen && auftrag.hauptspeisen && auftrag.hauptspeisen.length > 0) {
                // Beilagen gleichm√§√üig auf die Hauptspeisen verteilen (vereinfacht)
                auftrag.beilagen.forEach((beilage, index) => {
                    const hauptspeiseIndex = index % auftrag.hauptspeisen.length; // Rundlauf-Verteilung
                    const hauptspeiseBlocks = document.querySelectorAll('#hauptspeisen-container .speise-block');
                    
                    if (hauptspeiseBlocks[hauptspeiseIndex]) {
                        const beilagenContainer = hauptspeiseBlocks[hauptspeiseIndex].querySelector('.beilagen-container');
                        const containerId = beilagenContainer.id;
                        addBeilage(containerId);
                        
                        const letzteBeilage = beilagenContainer.querySelector('.speise-block:last-child');
                        letzteBeilage.querySelector('select').value = beilage.speise;
                        letzteBeilage.querySelector('input[type="number"]').value = beilage.anzahl;
                    }
                });
            }
            
            // Nachspeisen wiederherstellen
            if (auftrag.nachspeisen) {
                auftrag.nachspeisen.forEach(nachspeise => {
                    addNachspeise();
                    const letzterBlock = document.querySelector('#nachspeisen-container .speise-block:last-child');
                    
                    const kategorieSelect = letzterBlock.querySelector('select');
                    if (nachspeise.kategorie) {
                        kategorieSelect.value = nachspeise.kategorie;
                        
                        const nachspeiseId = letzterBlock.querySelector('[id$="_speisen"]').id.replace('_speisen', '');
                        updateNachspeisenOptionen(nachspeiseId);
                        
                        setTimeout(() => {
                            const speisenSelect = letzterBlock.querySelector('.nachspeise-auswahl');
                            const anzahlInput = letzterBlock.querySelector('input[type="number"]');
                            
                            if (speisenSelect && anzahlInput) {
                                speisenSelect.value = nachspeise.speise;
                                anzahlInput.value = nachspeise.anzahl;
                            }
                        }, 100);
                    }
                });
            }
            
            // Speichern-Button √§ndern
            const speichernButton = document.querySelector('button[onclick="speichereAuftrag()"]');
            speichernButton.textContent = 'üíæ √Ñnderungen speichern';
            speichernButton.setAttribute('onclick', `speichereAenderungen(${id})`);
            
            // Abbrechen-Button hinzuf√ºgen
            const abbrechenButton = document.createElement('button');
            abbrechenButton.textContent = '‚ùå Bearbeitung abbrechen';
            abbrechenButton.style.marginLeft = '10px';
            abbrechenButton.style.background = '#6c757d';
            abbrechenButton.setAttribute('onclick', 'brecheBearbeitungAb()');
            speichernButton.parentNode.insertBefore(abbrechenButton, speichernButton.nextSibling);
            
            window.scrollTo(0, 0);
            alert('Auftrag wird bearbeitet. √Ñndern Sie die Daten und klicken Sie "√Ñnderungen speichern".');
        }
        
        // √Ñnderungen speichern
        function speichereAenderungen(id) {
            const kunde = document.getElementById('kunde').value;
            const telefon = document.getElementById('telefon').value;
            const notizen = document.getElementById('notizen').value;
            const datum = document.getElementById('datum').value;
            const stunden = document.getElementById('stunden').value;
            const minuten = document.getElementById('minuten').value;
            const ort = document.getElementById('ort').value;
            const gaeste = document.getElementById('gaeste').value;
            
            if (!kunde || !datum || !stunden || !minuten || !ort || !gaeste) {
                alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                return;
            }
            
            const speisen = sammeleSpeisen();
            const beilagenZusammengefasst = fasseBeilagenZusammen(speisen.beilagen);
            
            const auftragIndex = auftraege.findIndex(a => a.id === id);
            if (auftragIndex !== -1) {
                auftraege[auftragIndex] = {
                    ...auftraege[auftragIndex],
                    kunde: kunde,
                    telefon: telefon,
                    notizen: notizen,
                    datum: datum,
                    zeit: stunden + ':' + minuten,
                    ort: ort,
                    gaeste: parseInt(gaeste),
                    vorspeisen: speisen.vorspeisen,
                    hauptspeisen: speisen.hauptspeisen,
                    beilagen: beilagenZusammengefasst,
                    nachspeisen: speisen.nachspeisen
                };
                
                brecheBearbeitungAb();
                zeigeAuftraege();
                updateStats();
                alert('Auftrag erfolgreich aktualisiert!');
            }
        }
        
        // Bearbeitung abbrechen
        function brecheBearbeitungAb() {
            // Formular leeren
            document.getElementById('kunde').value = '';
            document.getElementById('telefon').value = '';
            document.getElementById('notizen').value = '';
            document.getElementById('datum').value = '';
            document.getElementById('stunden').value = '';
            document.getElementById('minuten').value = '';
            document.getElementById('ort').value = '';
            document.getElementById('gaeste').value = '';
            document.getElementById('vorspeisen-container').innerHTML = '';
            document.getElementById('hauptspeisen-container').innerHTML = '';
            document.getElementById('nachspeisen-container').innerHTML = '';
            
            // Speichern-Button zur√ºcksetzen
            const speichernButton = document.querySelector('button[onclick*="speichereAenderungen"]');
            if (speichernButton) {
                speichernButton.textContent = '‚úÖ Auftrag speichern';
                speichernButton.setAttribute('onclick', 'speichereAuftrag()');
            }
            
            // Abbrechen-Button entfernen
            const abbrechenButton = document.querySelector('button[onclick="brecheBearbeitungAb()"]');
            if (abbrechenButton) {
                abbrechenButton.remove();
            }
        }
        
        // Hilfsfunktionen f√ºr Datums- und Wochenberechnung
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getDateFromWeek(year, week) {
            const jan4 = new Date(year, 0, 4);
            const dayOfWeek = jan4.getDay() || 7;
            const startOfWeek = new Date(jan4);
            startOfWeek.setDate(jan4.getDate() - dayOfWeek + 1 + (week - 1) * 7);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            return { start: startOfWeek, end: endOfWeek };
        }
        
        // Filter-Funktionen
        function updateFilterOptions() {
            const filterTyp = document.getElementById('filterTyp').value;
            const filterWert = document.getElementById('filterWert');
            const filterWoche = document.getElementById('filterWoche');
            
            filterWert.style.display = 'none';
            filterWoche.style.display = 'none';
            
            if (filterTyp === 'datum') {
                filterWert.style.display = 'block';
            } else if (filterTyp === 'woche') {
                filterWoche.style.display = 'block';
                updateWochenOptionen();
            }
            
            zeigeAuftraege();
        }

        function updateWochenOptionen() {
            const filterWoche = document.getElementById('filterWoche');
            const aktuelleDaten = auftraege.map(a => new Date(a.datum));
            const jahre = [...new Set(aktuelleDaten.map(d => d.getFullYear()))].sort();
            
            filterWoche.innerHTML = '<option value="">-- Kalenderwoche w√§hlen --</option>';
            
            jahre.forEach(jahr => {
                const jahresAuftraege = auftraege.filter(a => new Date(a.datum).getFullYear() === jahr);
                const wochen = [...new Set(jahresAuftraege.map(a => getWeekNumber(a.datum)))].sort((a, b) => a - b);
                
                wochen.forEach(woche => {
                    const { start, end } = getDateFromWeek(jahr, woche);
                    const option = document.createElement('option');
                    option.value = `${jahr}-${woche}`;
                    option.textContent = `KW ${woche}/${jahr} (${start.toLocaleDateString('de-DE')} - ${end.toLocaleDateString('de-DE')})`;
                    filterWoche.appendChild(option);
                });
            });
        }
        
        // Druck-Funktionen
        function druckeAuswahl() {
            const checked = Array.from(document.querySelectorAll(".druckauswahl:checked"));
            if (checked.length === 0) {
                alert("Bitte mindestens einen Auftrag zur Ausgabe ausw√§hlen.");
                return;
            }
            
            const ids = checked.map(cb => Number(cb.dataset.id));
            const auszudrucken = auftraege.filter(a => ids.includes(a.id));
            
            let html = '<h1>Partyservice Kleinfeldt - Ausgew√§hlte Auftr√§ge</h1>';
            html += '<p style="margin-bottom: 30px;">Kr√§henstra√üe 29, 23552 L√ºbeck | Tel: 0451-75230</p>';
            
            auszudrucken.forEach(auftrag => {
                html += `<div style='margin-bottom:30px; border-bottom: 1px solid #ccc; padding-bottom: 20px;'>
                    <h3>${auftrag.kunde}</h3>
                    <p><strong>Datum:</strong> ${auftrag.datum} ‚Äì ${auftrag.zeit}<br>
                    ${auftrag.telefon ? `<strong>Telefon:</strong> ${auftrag.telefon}<br>` : ''}
                    <strong>Ort:</strong> ${auftrag.ort}<br>
                    <strong>G√§ste:</strong> ${auftrag.gaeste}
                    ${auftrag.notizen ? `<br><strong>Notizen:</strong> ${auftrag.notizen}` : ''}</p>`;
                
                // Speisen f√ºr Druck formatieren
                if (auftrag.vorspeisen && auftrag.vorspeisen.length > 0) {
                    html += '<h4>Vorspeisen:</h4><ul>';
                    auftrag.vorspeisen.forEach(v => {
                        const liter = v.anzahl * 0.5;
                        const literText = liter >= 1 ? `${liter.toFixed(1)} L` : `${(liter * 1000)} ml`;
                        const brotText = v.brot ? ` + ${Math.ceil(v.anzahl / 6)} Brot${Math.ceil(v.anzahl / 6) > 1 ? 'e' : ''}` : '';
                        html += `<li>${v.speise} (${v.anzahl} Pers., ${literText})${brotText}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (auftrag.hauptspeisen && auftrag.hauptspeisen.length > 0) {
                    html += '<h4>Hauptspeisen:</h4><ul>';
                    auftrag.hauptspeisen.forEach(h => {
                        const berechnung = berechneHauptspeise(h.speise, h.anzahl);
                        const speisenName = h.speise.startsWith('individuell:') ? h.speise.replace('individuell: ', '') : h.speise;
                        
                        if (berechnung.gewicht > 0) {
                            const gewichtText = berechnung.gewicht >= 1000 ? `${(berechnung.gewicht/1000).toFixed(1)} kg` : `${berechnung.gewicht} g`;
                            html += `<li>${speisenName} (${h.anzahl} Pers., ${gewichtText})${berechnung.zusatz}</li>`;
                        } else if (berechnung.zusatz.includes('Schnitzel')) {
                            html += `<li>${speisenName} (${h.anzahl} Pers., ${berechnung.zusatz})</li>`;
                        } else {
                            html += `<li>${speisenName} (${h.anzahl} Pers.)${berechnung.zusatz}</li>`;
                        }
                    });
                    html += '</ul>';
                }
                
                if (auftrag.beilagen && auftrag.beilagen.length > 0) {
                    html += '<h4>Beilagen:</h4><ul>';
                    auftrag.beilagen.forEach(b => {
                        // Spezielle Behandlung f√ºr bestimmte Salate (nur Personenanzahl)
                        const nurPersonenSalate = ['frischer gemischter Salat', 'Griechischer Salat', 'Eisberg Melonen Salat'];
                        
                        if (nurPersonenSalate.includes(b.speise)) {
                            html += `<li>${b.speise} (${b.anzahl} Pers.)</li>`;
                        } else {
                            // Standard-Berechnung mit Gewicht (250g pro Person)
                            const gewicht = b.anzahl * 250;
                            const gewichtText = gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`;
                            html += `<li>${b.speise} (${b.anzahl} Pers., ${gewichtText})</li>`;
                        }
                    });
                    html += '</ul>';
                }
                
                if (auftrag.nachspeisen && auftrag.nachspeisen.length > 0) {
                    html += '<h4>Nachspeisen:</h4><ul>';
                    auftrag.nachspeisen.forEach(n => {
                        let kategorieText = '';
                        let mengenText = '';
                        
                        if (n.kategorie === 'Backshop') {
                            kategorieText = '[üßÅ Backshop] ';
                            if (n.speise && n.speise.startsWith('Blechkuchen')) {
                                const stuecke = n.anzahl * 15;
                                mengenText = `(${n.anzahl} Blech${n.anzahl > 1 ? 'e' : ''} = ${stuecke} St√ºcke)`;
                            } else {
                                mengenText = `(${n.anzahl} St√ºck)`;
                            }
                        } else {
                            const gewicht = n.anzahl * 120;
                            const gewichtText = gewicht >= 1000 ? `${(gewicht/1000).toFixed(1)} kg` : `${gewicht} g`;
                            
                            if (n.kategorie === 'N1') {
                                kategorieText = '[N1 - Gro√üe Schale] ';
                            } else if (n.kategorie === 'N2') {
                                kategorieText = '[N2 - Kleine Sch√§lchen] ';
                            } else if (n.kategorie === 'N3') {
                                kategorieText = '[N3 - Gourmet] ';
                            }
                            
                            mengenText = `(${n.anzahl} Pers., ${gewichtText})`;
                        }
                        
                        html += `<li>${kategorieText}${n.speise} ${mengenText}</li>`;
                        
                        // Backshop-Notizen in Druckansicht
                        if (n.backshopNotizen) {
                            html += `<li style="margin-left: 20px; font-style: italic;">üìù ${n.backshopNotizen}</li>`;
                        }
                    });
                    html += '</ul>';
                }
                
                html += '</div>';
            });
            
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                    <head>
                        <title>Partyservice Kleinfeldt - Druckansicht</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #667eea; border-bottom: 2px solid #667eea; }
                            h3 { color: #333; }
                            h4 { color: #667eea; margin-top: 15px; margin-bottom: 5px; }
                            ul { margin: 0; padding-left: 20px; }
                            li { margin-bottom: 3px; }
                        </style>
                    </head>
                    <body>${html}</body>
                </html>
            `);
            win.document.close();
            win.print();
        }
        
        // Backup-Funktionen (Dummy-Implementierungen f√ºr Claude.ai)
        function exportiereBackup() {
            const dateiName = `Partyservice_Backup_${new Date().toISOString().split('T')[0]}.json`;
            const datenString = JSON.stringify(auftraege, null, 2);
            
            // In Claude.ai k√∂nnen wir kein echtes Datei-Download machen
            // Stattdessen zeigen wir die Daten an
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                    <head>
                        <title>Backup-Daten</title>
                        <style>
                            body { font-family: monospace; margin: 20px; }
                            pre { background: #f5f5f5; padding: 20px; border-radius: 5px; }
                        </style>
                    </head>
                    <body>
                        <h1>Backup-Daten (${dateiName})</h1>
                        <p>Kopieren Sie diese Daten und speichern Sie sie als JSON-Datei:</p>
                        <pre>${datenString}</pre>
                    </body>
                </html>
            `);
            
            alert(`Backup erstellt! Die Daten werden in einem neuen Fenster angezeigt.`);
        }
        
        function importiereBackup() {
            const jsonData = prompt('Bitte f√ºgen Sie Ihre Backup-JSON-Daten hier ein:');
            
            if (!jsonData) return;
            
            try {
                const importierteDaten = JSON.parse(jsonData);
                
                if (Array.isArray(importierteDaten)) {
                    const sicherheitsabfrage = confirm(
                        `Import von ${importierteDaten.length} Auftr√§gen?\n\n` +
                        'ACHTUNG: Dies ersetzt alle aktuellen Daten!\n\n' +
                        'M√∂chten Sie fortfahren?'
                    );
                    
                    if (sicherheitsabfrage) {
                        auftraege = importierteDaten;
                        zeigeAuftraege();
                        updateStats();
                        alert(`${importierteDaten.length} Auftr√§ge erfolgreich importiert!`);
                    }
                } else {
                    alert('Ung√ºltiges Backup-Format!');
                }
            } catch (error) {
                console.error('Import-Fehler:', error);
                alert('Fehler beim Importieren der Datei!');
            }
        }
        
        function loescheAlleDaten() {
            const sicherheitsabfrage = confirm(
                'ACHTUNG: Alle Auftr√§ge l√∂schen?\n\n' +
                'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!\n\n' +
                'Empfehlung: Erstellen Sie zuerst ein Backup.\n\n' +
                'Wirklich alle Daten l√∂schen?'
            );
            
            if (sicherheitsabfrage) {
                auftraege = [];
                zeigeAuftraege();
                updateStats();
                alert('Alle Auftr√§ge wurden gel√∂scht!');
            }
        }
        
        // Statistiken aktualisieren
        function updateStats() {
            const heute = new Date().toISOString().split('T')[0];
            const heuteCount = auftraege.filter(a => a.datum === heute).length;
            
            // Woche berechnen (Montag bis Sonntag)
            const heute_date = new Date();
            const montag = new Date(heute_date);
            montag.setDate(heute_date.getDate() - heute_date.getDay() + 1);
            const sonntag = new Date(montag);
            sonntag.setDate(montag.getDate() + 6);
            
            const wocheCount = auftraege.filter(a => {
                const auftragsDatum = new Date(a.datum);
                return auftragsDatum >= montag && auftragsDatum <= sonntag;
            }).length;
            
            document.getElementById('total').textContent = `Gesamt: ${auftraege.length}`;
            document.getElementById('today').textContent = `Heute: ${heuteCount}`;
            document.getElementById('week').textContent = `Diese Woche: ${wocheCount}`;
        }
        
        // Initialisierung beim Laden der Seite
        window.onload = function() {
            updateStats();
            zeigeAuftraege();
            console.log('Partyservice Kleinfeldt - Auftragsverwaltung geladen');
        };
    </script>
</body>
</html>